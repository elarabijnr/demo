workflows:
  react_native_tally:
    name: React Native Tally App
    instance_type: mac_mini_m1
    environment:
      vars:
        NODE_VERSION: 18
        CI: 1
        EXPO_TOKEN: $EXPO_TOKEN
    scripts:
      - name: Install dependencies
        script: npm ci

      - name: Reinstall EAS CLI
        script: npm install -g eas-cli@latest

      - name: Verify Expo CLI
        script: |
          if ! command -v expo &> /dev/null; then
            echo "Expo CLI not found! Installing..."
            npm install -g expo-cli
          fi
          expo --version

      - name: Debug EXPO_TOKEN
        script: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "‚ùå EXPO_TOKEN is NOT set!"
            exit 1
          else
            echo "‚úÖ EXPO_TOKEN is set (Masked): ${EXPO_TOKEN:0:4}********"
          fi

      - name: Create eas.json if missing
        script: |
          if [ ! -f "eas.json" ]; then
            cat <<EOL > eas.json
{
  "build": {
    "development": {
      "extends": "default",
      "distribution": "internal",
      "android": { "buildType": "apk" },
      "ios": { "simulator": true }
    }
  }
}
EOL
          fi

      - name: Authenticate with Expo using EXPO_TOKEN
        script: |
          export EXPO_TOKEN="$EXPO_TOKEN"
          echo "EXPO_TOKEN exported"
          
          if [ -z "$EXPO_TOKEN" ]; then
            echo "‚ùå EXPO_TOKEN is not set. Please add it in Codemagic environment variables."
            exit 1
          fi

          echo "üîç Checking Expo authentication..."
          RESPONSE=$(curl -s -H "Authorization: Bearer $EXPO_TOKEN" https://exp.host/--/api/v2/authenticatedUser)
          echo "üîç Full API Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q "errors"; then
            echo "‚ùå Invalid EXPO_TOKEN! Please regenerate and update it."
            exit 1
          fi

          echo "‚úÖ EXPO_TOKEN is valid. Proceeding with authentication..."
          if ! npx eas whoami; then
            echo "‚ùå Authentication failed with eas whoami"
            exit 1
          fi

      - name: Build Android APK
        script: |
          export EXPO_TOKEN="$EXPO_TOKEN"
          npx eas build --platform android --profile development --non-interactive

      - name: Build iOS IPA
        script: |
          export EXPO_TOKEN="$EXPO_TOKEN"
          npx eas build --platform ios --profile development --non-interactive

    artifacts:
      - "**/*.apk"
      - "**/*.ipa"

    publishing:
      email:
        recipients:
          - "kengyap@upm.edu.my"
          - "elarabijnr@gmail.com"
